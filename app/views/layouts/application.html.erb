<!DOCTYPE html>
<html lang="en" 
      class="<%= current_user&.dark_mode? ? 'dark' : '' %>"
      data-theme="<%= current_user&.theme_preference || 'system' %>">
  <head>
    <!-- FOUC Prevention Script (must be in head) -->
    <script>
      (function() {
        function getTheme() {
          // Check localStorage first
          const stored = localStorage.getItem('theme');
          if (stored && ['light', 'dark', 'system'].includes(stored)) {
            return stored;
          }
          
          // Fall back to server-provided theme
          return document.documentElement.dataset.theme || 'system';
        }
        
        function applyTheme(theme) {
          const html = document.documentElement;
          html.classList.remove('dark', 'light');
          
          if (theme === 'dark') {
            html.classList.add('dark');
          } else if (theme === 'light') {
            html.classList.add('light');
          } else if (theme === 'system') {
            if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
              html.classList.add('dark');
            }
          }
          
          html.dataset.theme = theme;
        }
        
        // Apply theme immediately to prevent FOUC
        applyTheme(getTheme());
      })();
    </script>

    <!-- SEO Meta Tags -->
    <title><%= content_for(:seo_title) || seo_title %></title>
    <meta name="description" content="<%= content_for(:seo_description) || seo_description %>">
    <meta name="keywords" content="<%= seo_keywords %>">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="<%= canonical_url %>">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="<%= canonical_url %>">
    <meta property="og:title" content="<%= content_for(:seo_title) || seo_title %>">
    <meta property="og:description" content="<%= content_for(:seo_description) || seo_description %>">
    <meta property="og:image" content="<%= seo_image %>">
    <meta property="og:site_name" content="Voluntariness">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="<%= canonical_url %>">
    <meta property="twitter:title" content="<%= content_for(:seo_title) || seo_title %>">
    <meta property="twitter:description" content="<%= content_for(:seo_description) || seo_description %>">
    <meta property="twitter:image" content="<%= seo_image %>">
    
    <!-- Technical Meta Tags -->
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <%= yield :head %>
    
    <!-- Structured Data -->
    <%= yield :structured_data %>
    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>
    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">
    <%# Preload critical resources %>
    <link rel="preload" href="<%= asset_path('seifenblasen4.png') %>" as="image">
    
    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag "application.tailwind", "inter-font", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <link href="//stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" media="print" onload="this.media='all'"">
    <meta name="view-transition" content="same-origin" />
  </head>
  <body class="container mx-auto bg-green-200 dark:bg-slate-600" 
        id="body" 
        data-turbo-permanent 
        data-controller="theme" 
        data-theme-user-id-value="<%= current_user&.id %>"
        data-server-theme="<%= current_user&.theme_preference %>">
    <%= render "layouts/navbar" if user_signed_in? %>
    <div id="flash" class="flash">
      <%= render "layouts/action_flash" %>
    </div>
   <div class="container px-1 py-4 sm:px-2">
      <%= turbo_frame_tag "content" do %>
        <%= yield %>
      <% end %>
    </div>
    
    <!-- Load JavaScript after page content -->
    <%= javascript_importmap_tags %>
  </body>
</html>
